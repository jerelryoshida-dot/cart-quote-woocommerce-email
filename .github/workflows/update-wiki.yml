name: Update Wiki on Release

on:
  release:
    types: [published]

jobs:
  update-wiki:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update Wiki Update-Log
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the latest release tag and release notes
          TAG="${{ github.event.release.tag_name }}"
          BODY="${{ github.event.release.body }}"

          # Extract version from tag (remove 'v' prefix)
          VERSION=${TAG#v}
          RELEASE_DATE=$(date +%Y-%m-%d)

          echo "Updating wiki for version $VERSION"

          # Clone the wiki repository
          git clone https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.wiki.git wiki

          cd wiki

          # Check if Update-Log.md exists in .others/documentation/ location
          if [ -f "../.others/documentation/Update-Log.md" ]; then
            echo "Using Update-Log.md from .others/documentation/"
            cp "../.others/documentation/Update-Log.md" "Update-Log.md"
          elif [ ! -f "Update-Log.md" ]; then
            echo "Update-Log.md not found in .others/documentation/ or wiki!"
            exit 1
          fi

          # Create temporary file
          TEMP_FILE=$(mktemp)

          # Copy content up to and including "## Release History" header
          sed '/^## Release History/,$!d' Update-Log.md > "$TEMP_FILE"

          # Parse release notes to extract summary (first bullet point or first non-empty line)
          SUMMARY=$(echo "$BODY" | grep -E '^\-|^•' | head -1 | sed 's/^[-•]\s*//')

          # Create table row (match wiki table format)
          echo "" >> "$TEMP_FILE"
          echo "| [v$VERSION](https://github.com/${{ github.repository }}/releases/tag/$TAG) | $RELEASE_DATE | $SUMMARY |" >> "$TEMP_FILE"

          # Add table separator
          echo "|---------|------|---------|" >> "$TEMP_FILE"

          # Add existing table rows (skip headers, empty lines, and separator)
          tail -n +5 Update-Log.md >> "$TEMP_FILE"

          # Replace the original file
          mv "$TEMP_FILE" Update-Log.md

          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Update-Log.md
          git commit -m "Update wiki for release $TAG"
          git push origin master
