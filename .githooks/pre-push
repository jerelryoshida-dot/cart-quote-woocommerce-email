#!/bin/bash

# Pre-push hook to prevent .gitignore and .github/ from being pushed
# This hook runs before 'git push' and blocks the push if restricted files are included

# Files/folders that should stay local-only
LOCAL_ONLY_FILES=(
    ".gitignore"
    ".github/"
)

# Get the remote and branch being pushed to
remote="$1"
url="$2"

# Read stdin for ref updates
while read local_ref local_sha remote_ref remote_sha; do
    # Check if this is a new branch or existing
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        # New branch - check all commits
        range="$remote_sha..$local_sha"
    else
        # Existing branch - check commits not in remote
        range="$local_sha"
    fi
    
    # Check each restricted file
    for file in "${LOCAL_ONLY_FILES[@]}"; do
        # Check if file exists in any commit being pushed
        if git diff-tree --no-commit-id --name-only -r $range 2>/dev/null | grep -q "^${file}$\|^${file%/}"; then
            echo ""
            echo "=========================================="
            echo "ERROR: Attempted to push local-only file!"
            echo "=========================================="
            echo ""
            echo "The following file/folder is restricted to local-only:"
            echo "  - $file"
            echo ""
            echo "These files should remain local and not be pushed to:"
            echo "  Remote: $remote"
            echo "  Branch: $remote_ref"
            echo ""
            echo "To bypass this check (NOT RECOMMENDED):"
            echo "  git push --no-verify"
            echo ""
            exit 1
        fi
    done
done

exit 0
